@page "/templates"
@using System.Text.Json
@using TaskSurvey.Infrastructure.DTOs.SurveyDTOs
@using TaskSurvey.Infrastructure.DTOs.TemplateDTOs
@using TaskSurvey.Infrastructure.Models
@using TaskSurvey.Infrastructure.Utils
@using Microsoft.AspNetCore.WebUtilities
@layout MainLayout
@rendermode InteractiveServer
@inject ITemplateService TemplateService
@inject IJSRuntime JS
@inject IPositionService PositionService
@inject NavigationManager NavigationManager
@inject TaskSurvey.Infrastructure.Data.AppDbContext DbContext

<div class="container mt-4 mb-5">
    <div class="card shadow border-0">
        <div class="card-header bg-white p-3 border-bottom d-flex justify-content-between align-items-center">
            <h5 class="mb-0 text-primary fw-bold"><i class="bi bi-file-earmark-text me-2"></i>Survey Header</h5>
            @if (isEditMode) { <span class="badge bg-warning text-dark">Editing Mode</span> }
        </div>
        <div class="card-body p-4">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label fw-bold small text-uppercase text-secondary">Survey Template ID</label>
                    <div class="input-group shadow-sm">
                        <span class="input-group-text bg-light text-secondary"><i class="bi bi-hash"></i></span>
                        <input type="text" class="form-control bg-light fw-bold" @bind="reqDto.Id" readonly />
                        <button class="btn btn-primary" type="button" @onclick="() => showLookupModal = true">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-bold small text-uppercase text-secondary">Survey Template Name</label>
                    <input type="text" class="form-control shadow-sm" @bind="reqDto.TemplateName" placeholder="Enter template name..." />
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-bold small text-uppercase text-secondary">Position Level</label>
                    <select class="form-select shadow-sm" @bind="reqDto.PositionId">
                        <option value="0">-- Select Position --</option>
                        @foreach(var p in positions) { <option value="@p.Id">@p.PositionLevel</option> }
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-bold small text-uppercase text-secondary">Theme Color</label>
                    <input type="text" class="form-control shadow-sm" @bind="reqDto.Theme" placeholder="e.g. Blue, #FF5500" />
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow border-0 mt-4">
        <div class="card-header bg-dark text-white p-3 d-flex justify-content-between align-items-center">
            <h6 class="mb-0 fw-bold">Survey Items Management</h6>
            <button class="btn btn-sm btn-light fw-bold" @onclick="PrepareNewItem">
                <i class="bi bi-plus-lg me-1"></i> Add New Item
            </button>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered align-middle text-center">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 120px;">Action</th>
                            <th class="text-start">Question</th>
                            <th style="width: 150px;">Type</th>
                            <th style="width: 120px;">Order</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in reqDto.Items.OrderBy(x => x.OrderNo))
                        {
                            <tr>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => EditItem(item)"><i class="bi bi-pencil"></i></button>
                                    <button class="btn btn-sm btn-outline-danger" @onclick="() => RemoveItem(item)"><i class="bi bi-trash"></i></button>
                                </td>
                                <td class="text-start">@item.Question</td>
                                <td><span class="badge bg-info text-dark">@item.Type</span></td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-primary" @onclick="() => MoveUp(item)" disabled="@(reqDto.Items.OrderBy(x => x.OrderNo).FirstOrDefault() == item)"><i class="bi bi-chevron-up"></i></button>
                                        <button class="btn btn-primary" @onclick="() => MoveDown(item)" disabled="@(reqDto.Items.OrderBy(x => x.OrderNo).LastOrDefault() == item)"><i class="bi bi-chevron-down"></i></button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer bg-white text-end p-3 border-top">
            <button class="btn btn-outline-secondary me-2" @onclick="ResetForm">New / Reset</button>
            <button class="btn btn-success px-5 fw-bold" @onclick="SaveAll">Save Changes</button>
        </div>
    </div>
</div>

@if (showItemModal || showLookupModal)
{
    <div class="modal show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 1050;">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                @if (showItemModal)
                {
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title fw-bold">@(isEditItem ? "Edit Survey Item" : "Add New Item")</h5>
                        <button type="button" class="btn-close btn-close-white" @onclick="() => showItemModal = false"></button>
                    </div>
                    <div class="modal-body p-4">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Question / Label</label>
                            <input type="text" class="form-control" @bind="currentItem.Question" placeholder="Masukkan pertanyaan di sini..." />
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Answer Type</label>
                            <select class="form-select shadow-sm" @bind="currentItem.Type">
                                @foreach (var type in Enum.GetValues<QuestionType>())
                                {
                                    <option value="@type">@type</option>
                                }
                            </select>
                        </div>

                        @* Hanya muncul jika tipe adalah CheckBox *@
                        @if (currentItem.Type == QuestionType.CheckBox)
                        {
                            <div class="mt-4 p-3 border rounded-3 bg-light shadow-sm">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="form-label fw-bold text-dark mb-0">Options List</label>
                                    <button class="btn btn-sm btn-dark" @onclick="AddDetailRow">
                                        <i class="bi bi-plus"></i> Add Option
                                    </button>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover align-middle bg-white rounded shadow-sm">
                                        <thead class="table-light small">
                                            <tr><th class="ps-3">Option Label</th><th style="width: 50px;"></th></tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var det in currentItem.ItemDetails)
                                            {
                                                <tr>
                                                    <td><input type="text" class="form-control form-control-sm border-0" @bind="det.Item" placeholder="Ketik label pilihan..." /></td>
                                                    <td class="text-center"><button class="btn btn-sm text-danger" @onclick="() => currentItem.ItemDetails.Remove(det)"><i class="bi bi-trash"></i></button></td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        }
                    </div>
                    <div class="modal-footer bg-light">
                        <button class="btn btn-secondary" @onclick="() => showItemModal = false">Cancel</button>
                        <button class="btn btn-primary px-4 fw-bold" @onclick="SaveItemToTable">Save Item</button>
                    </div>
                }

                @if (showLookupModal)
                {
                    <div class="modal-header bg-dark text-white">
                        <h5 class="modal-title fw-bold"><i class="bi bi-search me-2"></i>Select Template</h5>
                        <button type="button" class="btn-close btn-close-white" @onclick="() => showLookupModal = false"></button>
                    </div>
                    <div class="modal-body p-0">
                        <div class="p-3 bg-light border-bottom">
                            <input type="text" class="form-control" placeholder="Search template name..." @bind="searchQuery" @bind:event="oninput" />
                        </div>
                        <div class="table-responsive" style="max-height: 400px;">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light"><tr><th class="ps-3">ID</th><th>Template Name</th><th class="text-center">Action</th></tr></thead>
                                <tbody>
                                    @foreach (var t in allTemplates.Where(x => x.TemplateName.Contains(searchQuery, StringComparison.OrdinalIgnoreCase)))
                                    {
                                        <tr>
                                            <td class="ps-3 fw-bold">@t.Id</td>
                                            <td>@t.TemplateName</td>
                                            <td class="text-center"><button class="btn btn-sm btn-primary px-3" @onclick="() => SelectTemplate(t.Id)">Select</button></td>
                                            <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteTemplate(t.Id)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
}

@code {
    private TemplateHeaderRequestDTO reqDto = new() { Items = new() };
    private List<PositionResponseDTO> positions = new();
    private List<TemplateHeaderResponseDTO> allTemplates = new();
    private TemplateItemRequestDTO currentItem = new();
    private TemplateItemRequestDTO _editingItemReference = new();
    private bool isEditItem = false, isEditMode = false;
    private bool showItemModal = false, showLookupModal = false;
    private string searchQuery = "";

    protected override async Task OnInitializedAsync()
    {
        positions = await PositionService.GetPositions();
        allTemplates = await TemplateService.GetTemplateHeaders();
        await GenerateNewId();
    }

    private async Task GenerateNewId() => reqDto.Id = await IdGeneratorUtil.GenerateTemplateId(DbContext);

    private async Task SelectTemplate(string id)
    {
        var data = await TemplateService.GetTemplateByHeaderId(id);
        if (data != null)
        {
            isEditMode = true;
            reqDto.Id = data.Id;
            reqDto.TemplateName = data.TemplateName;
            reqDto.PositionId = data.PositionId;
            reqDto.Theme = data.Theme;
            
            reqDto.Items = data.Items.Select(i => new TemplateItemRequestDTO {
                Id = i.Id,
                Question = i.Question, 
                Type = Enum.Parse<QuestionType>(i.Type, true), 
                OrderNo = i.OrderNo,
                ItemDetails = i.ItemDetails.Select(d => new TemplateItemDetailRequestDTO { 
                    Id = d.Id,
                    Item = d.Item 
                }).ToList()
            }).ToList();
            Console.WriteLine(JsonSerializer.Serialize(reqDto));
        }
        showLookupModal = false;
        StateHasChanged();
    }

    private void PrepareNewItem()
    {
        isEditItem = false;
        currentItem = new TemplateItemRequestDTO { Type = QuestionType.TextBox, ItemDetails = new() };
        showItemModal = true;
    }

    private void SaveItemToTable()
    {
        if (string.IsNullOrWhiteSpace(currentItem.Question)) return;

        if (isEditItem && _editingItemReference != null)
        {
            // Update data pada referensi item yang ada di list
            _editingItemReference.Question = currentItem.Question;
            _editingItemReference.Type = currentItem.Type;
            _editingItemReference.ItemDetails = currentItem.ItemDetails;
        }
        else
        {
            currentItem.OrderNo = reqDto.Items.Any() ? reqDto.Items.Max(x => x.OrderNo) + 1 : 1;
            reqDto.Items.Add(currentItem);
        }
        showItemModal = false;
    }

    private void EditItem(TemplateItemRequestDTO item) 
    { 
        isEditItem = true; 
        // Kita buat clone sementara agar jika modal di-cancel, data asli tidak berubah
        currentItem = new TemplateItemRequestDTO 
        {
            Id = item.Id,
            Question = item.Question,
            Type = item.Type,
            OrderNo = item.OrderNo,
            ItemDetails = item.ItemDetails.Select(d => new TemplateItemDetailRequestDTO { Id = d.Id, Item = d.Item }).ToList()
        };
        // Simpan referensi item yang sedang diedit untuk diupdate nanti
        _editingItemReference = item; 
        showItemModal = true; 
    }

    private void MoveUp(TemplateItemRequestDTO item)
    {
        var list = reqDto.Items.OrderBy(x => x.OrderNo).ToList();
        int idx = list.IndexOf(item);
        if (idx > 0)
        {
            var prev = list[idx - 1];
            int temp = item.OrderNo;
            item.OrderNo = prev.OrderNo;
            prev.OrderNo = temp;
        }
    }

    private void MoveDown(TemplateItemRequestDTO item)
    {
        var list = reqDto.Items.OrderBy(x => x.OrderNo).ToList();
        int idx = list.IndexOf(item);
        if (idx < list.Count - 1)
        {
            var next = list[idx + 1];
            int temp = item.OrderNo;
            item.OrderNo = next.OrderNo;
            next.OrderNo = temp;
        }
    }

    private void RemoveItem(TemplateItemRequestDTO item) => reqDto.Items.Remove(item);
    private void AddDetailRow() => currentItem.ItemDetails.Add(new TemplateItemDetailRequestDTO());

    private async Task SaveAll()
    {
        try 
        {
            if (isEditMode) 
            {
                await TemplateService.UpdateTemplate(reqDto.Id!, reqDto);
                Console.WriteLine("WOIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII\n"+JsonSerializer.Serialize(reqDto));
            }
            else 
            {
                await TemplateService.CreateTemplate(reqDto);
            }
            
            NavigationManager.NavigateTo("/templates"); 
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
    }

    private async Task DeleteTemplate(string id)
    {
        bool confirmed = await JS.InvokeAsync<bool>("confirm", $"Apakah Anda yakin ingin menghapus template {id}?");

        if (confirmed)
        {
            try 
            {
                var success = await TemplateService.DeleteTemplate(id);
                if (success)
                {
                    allTemplates = await TemplateService.GetTemplateHeaders();
                    if (reqDto.Id == id) await ResetAfterDelete();
                    StateHasChanged();
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error: {ex.Message}");
            }
        }
    }

    private async Task ResetAfterDelete()
    {
        isEditMode = false;
        reqDto = new() { Items = new() };
        await GenerateNewId();
    }

    private void ResetForm() => NavigationManager.NavigateTo("/templates", true);
}