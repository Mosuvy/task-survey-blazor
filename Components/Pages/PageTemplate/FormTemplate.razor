@page "/templates/form"
@using System.Text.Json
@using TaskSurvey.Infrastructure.DTOs.SurveyDTOs
@using TaskSurvey.Infrastructure.DTOs.TemplateDTOs
@using TaskSurvey.Infrastructure.Models
@using TaskSurvey.Infrastructure.Utils
@using Microsoft.AspNetCore.WebUtilities
@layout MainLayout
@rendermode InteractiveServer
@inject ITemplateService TemplateService
@inject IJSRuntime JS
@inject IPositionService PositionService
@inject NavigationManager NavigationManager
@inject TaskSurvey.Infrastructure.Data.AppDbContext DbContext
<PageTitle>Form Template</PageTitle>

<div class="container mt-4 mb-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header -->
            <div class="mb-3">
                <div class="d-flex align-items-center gap-2 mb-2">
                    <div class="text-white p-2 rounded" style="background: #0ea5e9;">
                        <i class="bi bi-file-earmark-text fs-5"></i>
                    </div>
                    <div>
                        <h4 class="mb-0 fw-bold text-dark">@(isEditMode ? "Edit Template" : "Create New Template")</h4>
                        <p class="text-muted mb-0" style="font-size: 0.85rem;">@(isEditMode ? $"Modify template for ID: {reqDto.Id}" : "Create a new survey template")</p>
                    </div>
                </div>
            </div>

            <!-- Survey Header Card -->
            <div class="card border-0 shadow-sm rounded-3 mb-3">
                <div class="card-header text-white py-2 px-3" style="background: #0ea5e9;">
                    <h6 class="mb-0 fw-semibold">
                        <i class="bi bi-card-heading me-2"></i>Survey Header
                    </h6>
                </div>
                
                <div class="card-body p-3">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold text-dark mb-1" style="font-size: 0.9rem;">
                                <i class="bi bi-hash me-1" style="color: #0ea5e9;"></i>Template ID
                            </label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0">
                                    <i class="bi bi-fingerprint" style="color: #0ea5e9;"></i>
                                </span>
                                <input type="text" class="form-control bg-light fw-semibold border-start-0" @bind="reqDto.Id" readonly style="font-size: 0.95rem;" />
                                <button class="btn text-white px-3" type="button" @onclick="() => showLookupModal = true"
                                        style="background: #0ea5e9; border: none;">
                                    <i class="bi bi-search me-1"></i>Lookup
                                </button>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-semibold text-dark mb-1" style="font-size: 0.9rem;">
                                <i class="bi bi-text-left me-1" style="color: #0ea5e9;"></i>Template Name
                            </label>
                            <input type="text" class="form-control" @bind="reqDto.TemplateName" 
                                   placeholder="Enter template name..." style="font-size: 0.95rem;" />
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-semibold text-dark mb-1" style="font-size: 0.9rem;">
                                <i class="bi bi-diagram-3 me-1" style="color: #0ea5e9;"></i>Position Level
                            </label>
                            <select class="form-select" @bind="reqDto.PositionId" style="font-size: 0.95rem;">
                                <option value="0">-- Select Position --</option>
                                @foreach(var p in positions) { <option value="@p.Id">@p.PositionLevel</option> }
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-semibold text-dark mb-1" style="font-size: 0.9rem;">
                                <i class="bi bi-palette me-1" style="color: #0ea5e9;"></i>Theme
                            </label>
                            <input type="text" class="form-control" @bind="reqDto.Theme" 
                                   placeholder="Pengajuan Barang" style="font-size: 0.95rem;" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Survey Items Card -->
            <div class="card border-0 shadow-sm rounded-3 mb-3">
                <div class="card-header text-white py-2 px-3 d-flex justify-content-between align-items-center" style="background: #64748b;">
                    <h6 class="mb-0 fw-semibold">
                        <i class="bi bi-list-check me-2"></i>Survey Pengajuan
                    </h6>
                    <button class="btn btn-sm text-dark px-3" @onclick="PrepareNewItem"
                            style="background: white; border: none; font-weight: 600;">
                        <i class="bi bi-plus-circle me-1"></i>Add Item
                    </button>
                </div>
                
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0" style="font-size: 0.9rem;">
                            <thead style="background: #f8f9fa;">
                                <tr>
                                    <th class="py-3 px-3 fw-semibold text-dark" style="width: 120px;">Action</th>
                                    <th class="py-3 px-3 fw-semibold text-dark text-start">Question</th>
                                    <th class="py-3 px-3 fw-semibold text-dark" style="width: 150px;">Type</th>
                                    <th class="py-3 px-3 fw-semibold text-dark" style="width: 120px;">Order</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (reqDto.Items.Count == 0)
                                {
                                    <tr>
                                        <td colspan="4" class="text-center py-5 text-muted">
                                            <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                            <p class="mb-0">No items added yet</p>
                                        </td>
                                    </tr>
                                }
                                else
                                {
                                    @foreach (var item in reqDto.Items.OrderBy(x => x.OrderNo))
                                    {
                                        <tr>
                                            <td class="px-3 py-3">
                                                <button class="btn btn-sm me-1 text-white" @onclick="() => EditItem(item)"
                                                        style="background: #0ea5e9; border: none;">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn btn-sm text-white" @onclick="() => RemoveItem(item)"
                                                        style="background: #ef4444; border: none;">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                            <td class="px-3 py-3 text-start">@item.Question</td>
                                            <td class="px-3 py-3">
                                                <span class="badge rounded-pill" style="background: #0ea5e9;">@item.Type</span>
                                            </td>
                                            <td class="px-3 py-3">
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn text-white" @onclick="() => MoveUp(item)" 
                                                            disabled="@(reqDto.Items.OrderBy(x => x.OrderNo).FirstOrDefault() == item)"
                                                            style="background: #0ea5e9; border: none;">
                                                        <i class="bi bi-chevron-up"></i>
                                                    </button>
                                                    <button class="btn text-white" @onclick="() => MoveDown(item)" 
                                                            disabled="@(reqDto.Items.OrderBy(x => x.OrderNo).LastOrDefault() == item)"
                                                            style="background: #0ea5e9; border: none;">
                                                        <i class="bi bi-chevron-down"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex gap-2 flex-wrap">
                <button class="btn text-white px-4 shadow-sm" @onclick="SaveAll"
                        style="background: #10b981; border: none;">
                    <i class="bi bi-check-circle me-2"></i>Submit
                </button>
                <button class="btn text-white px-3 shadow-sm" @onclick="ResetForm"
                        style="background: #0ea5e9; border: none;">
                    <i class="bi bi-file-earmark-plus me-2"></i>New
                </button>
                @if (isEditMode)
                {
                    <button class="btn text-white px-3 shadow-sm" @onclick="DeleteCurrentTemplate"
                            style="background: #ef4444; border: none;">
                        <i class="bi bi-trash me-2"></i>Delete
                    </button>
                }
                <button class="btn btn-outline-secondary px-3 ms-auto" @onclick='() => NavigationManager.NavigateTo("/templates")'>
                    <i class="bi bi-x-circle me-2"></i>Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Item Modal -->
@if (showItemModal)
{
    <div class="modal show d-block" tabindex="-1" style="background: rgba(0,0,0,0.6);">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-3">
                <div class="modal-header text-white py-2 px-3" style="background: #0ea5e9;">
                    <h6 class="modal-title fw-semibold mb-0">
                        <i class="bi bi-file-earmark-text me-2"></i>
                        @(isEditItem ? "Edit Survey Item" : "Add New Item")
                    </h6>
                    <button type="button" class="btn-close btn-close-white" @onclick="() => showItemModal = false"></button>
                </div>
                <div class="modal-body p-3">
                    <div class="mb-3">
                        <label class="form-label fw-semibold text-dark mb-1" style="font-size: 0.9rem;">Question / Label</label>
                        <input type="text" class="form-control" @bind="currentItem.Question" 
                               placeholder="Enter question here..." style="font-size: 0.95rem;" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold text-dark mb-1" style="font-size: 0.9rem;">Answer Type</label>
                        <select class="form-select" @bind="currentItem.Type" style="font-size: 0.95rem;">
                            @foreach (var type in Enum.GetValues<QuestionType>())
                            {
                                <option value="@type">@type</option>
                            }
                        </select>
                    </div>

                    @if (currentItem.Type == QuestionType.CheckBox)
                    {
                        <div class="p-3 border rounded-3 bg-light">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label fw-semibold text-dark mb-0" style="font-size: 0.9rem;">Options List</label>
                                <button class="btn btn-sm text-white px-3" @onclick="AddDetailRow"
                                        style="background: #64748b; border: none;">
                                    <i class="bi bi-plus me-1"></i>Add
                                </button>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-sm table-hover align-middle bg-white rounded mb-0" style="font-size: 0.9rem;">
                                    <thead style="background: #f8f9fa;">
                                        <tr>
                                            <th class="ps-3 py-2 fw-semibold">Option Label</th>
                                            <th style="width: 50px;"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var det in currentItem.ItemDetails)
                                        {
                                            <tr>
                                                <td class="ps-3">
                                                    <input type="text" class="form-control form-control-sm" 
                                                           @bind="det.Item" placeholder="Enter option label..." />
                                                </td>
                                                <td class="text-center">
                                                    <button class="btn btn-sm" @onclick="() => currentItem.ItemDetails.Remove(det)"
                                                            style="color: #ef4444;">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    }
                </div>
                <div class="modal-footer bg-light py-2 px-3">
                    <button class="btn btn-outline-secondary px-3" @onclick="() => showItemModal = false">Cancel</button>
                    <button class="btn text-white px-4" @onclick="SaveItemToTable"
                            style="background: #0ea5e9; border: none;">
                        Save Item
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Lookup Modal -->
@if (showLookupModal)
{
    <div class="modal show d-block" tabindex="-1" style="background: rgba(0,0,0,0.6);">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-3">
                <div class="modal-header text-white py-2 px-3" style="background: #64748b;">
                    <h6 class="modal-title fw-semibold mb-0">
                        <i class="bi bi-search me-2"></i>Select Template
                    </h6>
                    <button type="button" class="btn-close btn-close-white" @onclick="() => showLookupModal = false"></button>
                </div>
                <div class="modal-body p-3">
                    <div class="input-group mb-3">
                        <span class="input-group-text bg-light">
                            <i class="bi bi-funnel" style="color: #0ea5e9;"></i>
                        </span>
                        <input type="text" class="form-control" placeholder="Search template name..." 
                               @bind="searchQuery" @bind:event="oninput" style="font-size: 0.95rem;" />
                    </div>
                    <div class="table-responsive" style="max-height: 400px;">
                        <table class="table table-hover align-middle mb-0" style="font-size: 0.9rem;">
                            <thead class="table-light">
                                <tr>
                                    <th class="fw-semibold ps-3">ID</th>
                                    <th class="fw-semibold">Template Name</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var t in allTemplates.Where(x => x.TemplateName.Contains(searchQuery, StringComparison.OrdinalIgnoreCase)))
                                {
                                    <tr style="cursor: pointer;" @onclick="() => SelectTemplate(t.Id)">
                                        <td class="ps-3 fw-semibold" style="color: #0ea5e9;">@t.Id</td>
                                        <td>@t.TemplateName</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private TemplateHeaderRequestDTO reqDto = new() { Items = new() };
    private List<PositionResponseDTO> positions = new();
    private List<TemplateHeaderResponseDTO> allTemplates = new();
    private TemplateItemRequestDTO currentItem = new();
    private TemplateItemRequestDTO _editingItemReference = new();
    private bool isEditItem = false, isEditMode = false;
    private bool showItemModal = false, showLookupModal = false;
    private string searchQuery = "";

    protected override async Task OnInitializedAsync()
    {
        positions = await PositionService.GetPositions();
        allTemplates = await TemplateService.GetTemplateHeaders();

        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        if (QueryHelpers.ParseQuery(uri.Query).TryGetValue("templateId", out var id))
        {
            await SelectTemplate(id!);
        }
        else
        {
            await GenerateNewId();
        }
    }

    private async Task GenerateNewId() => reqDto.Id = await IdGeneratorUtil.GenerateTemplateId(DbContext);

    private async Task SelectTemplate(string id)
    {
        var data = await TemplateService.GetTemplateByHeaderId(id);
        if (data != null)
        {
            isEditMode = true;
            reqDto.Id = data.Id;
            reqDto.TemplateName = data.TemplateName;
            reqDto.PositionId = data.PositionId;
            reqDto.Theme = data.Theme;
            
            reqDto.Items = data.Items.Select(i => new TemplateItemRequestDTO {
                Id = i.Id,
                Question = i.Question, 
                Type = Enum.Parse<QuestionType>(i.Type, true), 
                OrderNo = i.OrderNo,
                ItemDetails = i.ItemDetails.Select(d => new TemplateItemDetailRequestDTO { 
                    Id = d.Id,
                    Item = d.Item 
                }).ToList()
            }).ToList();
        }
        showLookupModal = false;
        StateHasChanged();
    }

    private void PrepareNewItem()
    {
        isEditItem = false;
        currentItem = new TemplateItemRequestDTO { Type = QuestionType.TextBox, ItemDetails = new() };
        showItemModal = true;
    }

    private void SaveItemToTable()
    {
        if (string.IsNullOrWhiteSpace(currentItem.Question)) return;

        if (isEditItem && _editingItemReference != null)
        {
            _editingItemReference.Question = currentItem.Question;
            _editingItemReference.Type = currentItem.Type;
            _editingItemReference.ItemDetails = currentItem.ItemDetails;
        }
        else
        {
            currentItem.OrderNo = reqDto.Items.Any() ? reqDto.Items.Max(x => x.OrderNo) + 1 : 1;
            reqDto.Items.Add(currentItem);
        }
        showItemModal = false;
    }

    private void EditItem(TemplateItemRequestDTO item) 
    { 
        isEditItem = true; 
        currentItem = new TemplateItemRequestDTO 
        {
            Id = item.Id,
            Question = item.Question,
            Type = item.Type,
            OrderNo = item.OrderNo,
            ItemDetails = item.ItemDetails.Select(d => new TemplateItemDetailRequestDTO { Id = d.Id, Item = d.Item }).ToList()
        };
        _editingItemReference = item; 
        showItemModal = true; 
    }

    private void MoveUp(TemplateItemRequestDTO item)
    {
        var list = reqDto.Items.OrderBy(x => x.OrderNo).ToList();
        int idx = list.IndexOf(item);
        if (idx > 0)
        {
            var prev = list[idx - 1];
            int temp = item.OrderNo;
            item.OrderNo = prev.OrderNo;
            prev.OrderNo = temp;
        }
    }

    private void MoveDown(TemplateItemRequestDTO item)
    {
        var list = reqDto.Items.OrderBy(x => x.OrderNo).ToList();
        int idx = list.IndexOf(item);
        if (idx < list.Count - 1)
        {
            var next = list[idx + 1];
            int temp = item.OrderNo;
            item.OrderNo = next.OrderNo;
            next.OrderNo = temp;
        }
    }

    private void RemoveItem(TemplateItemRequestDTO item) => reqDto.Items.Remove(item);
    private void AddDetailRow() => currentItem.ItemDetails.Add(new TemplateItemDetailRequestDTO());

    private async Task SaveAll()
    {
        try 
        {
            if (isEditMode) 
            {
                await TemplateService.UpdateTemplate(reqDto.Id!, reqDto);
            }
            else 
            {
                await TemplateService.CreateTemplate(reqDto);
            }
            
            NavigationManager.NavigateTo("/templates");
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
    }

    private async Task DeleteCurrentTemplate()
    {
        bool confirmed = await JS.InvokeAsync<bool>("confirm", $"Are you sure you want to delete template {reqDto.Id}?");

        if (confirmed)
        {
            try 
            {
                var success = await TemplateService.DeleteTemplate(reqDto.Id!);
                if (success)
                {
                    NavigationManager.NavigateTo("/templates");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error: {ex.Message}");
            }
        }
    }

    private async Task ResetForm()
    {
        isEditMode = false;
        reqDto = new() { Items = new() };
        await GenerateNewId();
        NavigationManager.NavigateTo("/templates/form");
    }
}