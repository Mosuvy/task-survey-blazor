@page "/surveys/form"
@layout MainLayout
@rendermode InteractiveServer
@inject ISurveyService SurveyService
@inject ITemplateService TemplateService
@inject IUserService UserService
@inject NavigationManager NavigationManager
@inject TaskSurvey.StateServices.AuthState AuthState
@inject TaskSurvey.Infrastructure.Data.AppDbContext DbContext
@inject IJSRuntime JS

<PageTitle>Survey Form</PageTitle>

<div class="container-fluid px-4 py-4 bg-main" style="min-height: 100vh;">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header -->
            <div class="mb-4">
                <div class="d-flex align-items-center gap-3 mb-2">
                    <div class="bg-primary text-white p-3 rounded-3 shadow-sm">
                        <i class="bi bi-clipboard-check fs-4"></i>
                    </div>
                    <div>
                        <h3 class="mb-1 fw-bold text-title">@GetPageTitle()</h3>
                        <p class="text-muted mb-0" style="font-size: 0.9rem;">@GetPageSubtitle()</p>
                    </div>
                </div>
            </div>

            <!-- Alerts -->
            @if (!string.IsNullOrEmpty(alertMessage))
            {
                <div class="alert alert-danger border-0 shadow-sm mb-3 alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>Error!</strong> @alertMessage
                    <button type="button" class="btn-close" @onclick="() => alertMessage = null"></button>
                </div>
            }

            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="alert alert-success border-0 shadow-sm mb-3 alert-dismissible fade show" role="alert">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <strong>Success!</strong> @successMessage
                    <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
                </div>
            }

            <!-- View Only Notice -->
            @if (isViewOnly && !isSupervisor)
            {
                <div class="alert alert-info border-0 shadow-sm mb-3 d-flex align-items-center" role="alert">
                    <i class="bi bi-info-circle-fill me-2 fs-5"></i>
                    <div>
                        <strong>View Only Mode:</strong> This survey is already submitted for approval. You can only view the content.
                    </div>
                </div>
            }

            <!-- Template Update Warning -->
            @if (showTemplateUpdateWarning && !isSupervisor && reqDto.Status == StatusType.Draft && !isViewOnly)
            {
                <div class="alert alert-warning border-0 shadow-sm mb-3 d-flex align-items-center justify-content-between" role="alert">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle-fill me-2 fs-5"></i>
                        <div>
                            <strong>Template Updated!</strong> The template has been updated since this survey was created. 
                            <span class="text-muted">Click the button to update to the latest version.</span>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-warning px-3" @onclick="() => showUpdateTemplateModal = true">
                        <i class="bi bi-arrow-repeat me-1"></i>Update Template
                    </button>
                </div>
            }

            <!-- Supervisor View Notice -->
            @if (isSupervisor)
            {
                <div class="alert alert-info border-0 shadow-sm mb-3 d-flex align-items-center" role="alert">
                    <i class="bi bi-info-circle-fill me-2 fs-5"></i>
                    <div>
                        <strong>Supervisor Mode:</strong> You are viewing this survey in read-only mode. You can only approve or reject this submission.
                    </div>
                </div>
            }

            <!-- Document Info Cards -->
            <div class="row g-3 mb-3">
                <div class="col-md-3">
                    <div class="card border-custom shadow-sm rounded-3 h-100 bg-card">
                        <div class="card-body p-3">
                            <p class="text-muted mb-1" style="font-size: 0.75rem;">DOCUMENT NO.</p>
                            <h6 class="fw-bold mb-0 text-primary">@(reqDto.DocumentId ?? "GENERATING...")</h6>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-custom shadow-sm rounded-3 h-100 bg-card">
                        <div class="card-body p-3">
                            <p class="text-muted mb-1" style="font-size: 0.75rem;">DOCUMENT DATE</p>
                            <h6 class="fw-bold mb-0 text-body">@DateTime.Now.ToString("dd MMM yyyy")</h6>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-custom shadow-sm rounded-3 h-100 bg-card">
                        <div class="card-body p-3">
                            <p class="text-muted mb-1" style="font-size: 0.75rem;">STATUS</p>
                            <span class="badge rounded-pill @GetStatusBadgeClass(GetCurrentStatus())">
                                @GetStatusDisplay(GetCurrentStatus())
                            </span>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-custom shadow-sm rounded-3 h-100 bg-card">
                        <div class="card-body p-3">
                            <p class="text-muted mb-1" style="font-size: 0.75rem;">CREATED BY</p>
                            <h6 class="fw-bold mb-0 text-body">@(requesterData != null ? requesterData.Username : "N/A")</h6>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Requester Information -->
            <div class="card border-custom shadow-sm rounded-3 mb-3 bg-card">
                <div class="card-header bg-primary text-white py-3 px-4 border-0">
                    <h6 class="mb-0 fw-semibold">
                        <i class="bi bi-person-badge me-2"></i>Requester Information
                    </h6>
                </div>
                <div class="card-body p-4">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label fw-semibold text-title mb-2">Employee ID</label>
                            <input type="text" class="form-control bg-main border-custom" value="@(requesterData != null ? requesterData.Id : "")" readonly />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold text-title mb-2">Employee Name</label>
                            <input type="text" class="form-control bg-main border-custom" value="@(requesterData != null ? requesterData.Username : "")" readonly />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold text-title mb-2">Position Name</label>
                            <input type="text" class="form-control bg-main border-custom" value="@(requesterData != null ? requesterData.PositionName : "")" readonly />
                        </div>
                    </div>
                    <div class="row g-3 mt-1">
                        <div class="col-md-4">
                            <label class="form-label fw-semibold text-title mb-2">Supervisor ID</label>
                            <input type="text" class="form-control bg-main border-custom" value="@(requesterData?.Supervisor != null ? requesterData.Supervisor.Id : "-")" readonly />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold text-title mb-2">Supervisor Name</label>
                            <input type="text" class="form-control bg-main border-custom" value="@(requesterData?.Supervisor != null ? requesterData.Supervisor.Username : "-")" readonly />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold text-title mb-2">Position Name</label>
                            <input type="text" class="form-control bg-main border-custom" value="@(requesterData?.Supervisor != null ? requesterData.Supervisor.PositionName : "-")" readonly />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Survey Template Selection -->
            <div class="card border-custom shadow-sm rounded-3 mb-3 bg-card">
                <div class="card-header bg-secondary text-white py-3 px-4 border-0">
                    <h6 class="mb-0 fw-semibold">
                        <i class="bi bi-file-earmark-text me-2"></i>Survey Template
                    </h6>
                </div>
                <div class="card-body p-4">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold text-title mb-2">
                                Template ID <span class="text-danger">*</span>
                            </label>
                            @if (isViewOnly || isSupervisor)
                            {
                                <input type="text" class="form-control bg-main border-custom" value="@reqDto.TemplateHeaderId" readonly />
                            }
                            else
                            {
                                <div class="input-group">
                                    <span class="input-group-text bg-main border-custom">
                                        <i class="bi bi-fingerprint text-primary"></i>
                                    </span>
                                    <input type="text" class="form-control bg-main border-custom @(hasAttemptedSubmit && string.IsNullOrEmpty(reqDto.TemplateHeaderId) ? "is-invalid" : "")" 
                                           value="@reqDto.TemplateHeaderId" readonly />
                                    <button class="btn btn-primary px-3" type="button" @onclick="() => showTemplateModal = true"
                                            disabled="@isViewOnly">
                                        <i class="bi bi-search me-1"></i>Select
                                    </button>
                                </div>
                                @if (hasAttemptedSubmit && string.IsNullOrEmpty(reqDto.TemplateHeaderId))
                                {
                                    <div class="invalid-feedback d-block">
                                        <i class="bi bi-exclamation-circle me-1"></i>Please select a template
                                    </div>
                                }
                            }
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold text-title mb-2">Template Name</label>
                            <input type="text" class="form-control bg-main border-custom" value="@selectedTemplateName" readonly />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold text-title mb-2">Template Theme</label>
                            <input type="text" class="form-control bg-main border-custom" value="@selectedTemplateTheme" readonly />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Survey Items (Collapsible) -->
            <div class="card border-custom shadow-sm rounded-3 mb-3 bg-card">
                <div class="card-header py-3 px-4 border-bottom border-custom bg-card"
                     style="cursor: pointer;"
                     data-bs-toggle="collapse"
                     data-bs-target="#surveyItemsCollapse"
                     aria-expanded="true"
                     aria-controls="surveyItemsCollapse">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0 fw-semibold text-title">
                            <i class="bi bi-list-check me-2 text-primary"></i>Survey Pengajuan
                            <span class="badge bg-primary ms-2">@reqDto.SurveyItems.Count Items</span>
                        </h6>
                        <i class="bi bi-chevron-down text-primary transition-icon"></i>
                    </div>
                </div>
                <div class="collapse show" id="surveyItemsCollapse">
                    <div class="card-body p-4">
                        @if (reqDto.SurveyItems.Count == 0)
                        {
                            <div class="text-center py-5 text-muted">
                                <i class="bi bi-inbox fs-1 d-block mb-3"></i>
                                <p class="mb-2 fw-semibold">No survey items yet</p>
                                <p class="mb-0">Please select a template first</p>
                            </div>
                        }
                        else
                        {
                            @foreach (var item in reqDto.SurveyItems.OrderBy(x => x.OrderNo))
                            {
                                <div class="mb-4">
                                    <label class="form-label fw-bold text-title mb-3" style="font-size: 1rem;">
                                        @item.OrderNo. @item.Question
                                        @if (!isViewOnly && !isSupervisor)
                                        {
                                            <span class="text-danger">*</span>
                                        }
                                    </label>
                                    
                                    @if (item.Type == QuestionType.TextBox)
                                    {
                                        <input type="text" class="form-control border-custom @(isViewOnly ? "bg-main" : "") @(hasAttemptedSubmit && string.IsNullOrWhiteSpace(item.Answer) ? "is-invalid" : "")" 
                                               value="@item.Answer" 
                                               placeholder="Type your answer here..." 
                                               readonly="@isViewOnly"
                                               disabled="@(isViewOnly || isSupervisor)"
                                               @onchange="@((ChangeEventArgs e) => {
                                                   if (!isViewOnly && !isSupervisor) item.Answer = e.Value?.ToString()!;
                                               })" />
                                        @if (hasAttemptedSubmit && string.IsNullOrWhiteSpace(item.Answer))
                                        {
                                            <div class="invalid-feedback d-block">
                                                <i class="bi bi-exclamation-circle me-1"></i>This field is required
                                            </div>
                                        }
                                    }
                                    else if (item.Type == QuestionType.TextArea)
                                    {
                                        <textarea class="form-control border-custom @(isViewOnly ? "bg-main" : "") @(hasAttemptedSubmit && string.IsNullOrWhiteSpace(item.Answer) ? "is-invalid" : "")" 
                                                  rows="4" 
                                                  placeholder="Type your answer here..." 
                                                  readonly="@isViewOnly"
                                                  disabled="@(isViewOnly || isSupervisor)"
                                                  @onchange="@((ChangeEventArgs e) => {
                                                      if (!isViewOnly && !isSupervisor) item.Answer = e.Value?.ToString()!;
                                                  })">@item.Answer</textarea>
                                        @if (hasAttemptedSubmit && string.IsNullOrWhiteSpace(item.Answer))
                                        {
                                            <div class="invalid-feedback d-block">
                                                <i class="bi bi-exclamation-circle me-1"></i>This field is required
                                            </div>
                                        }
                                    }
                                    else if (item.Type == QuestionType.Number)
                                    {
                                        <input type="number" class="form-control border-custom @(isViewOnly ? "bg-main" : "") @(hasAttemptedSubmit && string.IsNullOrWhiteSpace(item.Answer) ? "is-invalid" : "")" 
                                               value="@item.Answer" 
                                               placeholder="Enter number..." 
                                               readonly="@isViewOnly"
                                               disabled="@(isViewOnly || isSupervisor)"
                                               @onchange="@((ChangeEventArgs e) => {
                                                   if (!isViewOnly && !isSupervisor) item.Answer = e.Value?.ToString()!;
                                               })" />
                                        @if (hasAttemptedSubmit && string.IsNullOrWhiteSpace(item.Answer))
                                        {
                                            <div class="invalid-feedback d-block">
                                                <i class="bi bi-exclamation-circle me-1"></i>This field is required
                                            </div>
                                        }
                                    }
                                    else if (item.Type == QuestionType.CheckBox)
                                    {
                                        <div class="card border-custom @(isViewOnly ? "bg-main" : "") p-3 rounded-3">
                                            @foreach (var detail in item.CheckBox)
                                            {
                                                <div class="form-check mb-2">
                                                    <input class="form-check-input" type="checkbox" 
                                                           checked="@detail.IsChecked"
                                                           disabled="@(isViewOnly || isSupervisor)"
                                                           id="det-@detail.Id"
                                                           @onchange="@((ChangeEventArgs e) => {
                                                               if (!isViewOnly && !isSupervisor) detail.IsChecked = (bool)(e.Value ?? false);
                                                           })" />
                                                    <label class="form-check-label ms-2 text-body" for="det-@detail.Id">
                                                        @detail.Item
                                                    </label>
                                                </div>
                                            }
                                        </div>
                                        @if (hasAttemptedSubmit && !item.CheckBox.Any(cb => cb.IsChecked))
                                        {
                                            <div class="text-danger small mt-2">
                                                <i class="bi bi-exclamation-circle me-1"></i>Please select at least one option
                                            </div>
                                        }
                                    }
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex gap-2 flex-wrap mb-5">
                @if (isSupervisor)
                {
                    @if (reqDto.Status == StatusType.ConfirmToApprove)
                    {
                        <button class="btn btn-success-custom px-4 py-2 shadow-sm" @onclick="() => showApproveModal = true">
                            <i class="bi bi-check-circle me-2"></i>Approve
                        </button>
                        <button class="btn btn-danger-custom px-4 py-2 shadow-sm" @onclick="() => showRejectModal = true">
                            <i class="bi bi-x-circle me-2"></i>Reject
                        </button>
                    }
                }
                else if (!isViewOnly)
                {
                    <button class="btn btn-success-custom px-4 py-2 shadow-sm" @onclick="ValidateAndShowSubmitModal">
                        <i class="bi bi-check-circle me-2"></i>Submit
                    </button>
                    <button class="btn btn-warning px-4 py-2 shadow-sm text-white" @onclick="HandleSaveDraft">
                        <i class="bi bi-save me-2"></i>Save Draft
                    </button>
                    @if (isEditMode && reqDto.Status == StatusType.Draft)
                    {
                        <button class="btn btn-danger-custom px-4 py-2 shadow-sm" @onclick="() => showDeleteModal = true">
                            <i class="bi bi-trash me-2"></i>Delete
                        </button>
                    }
                }
                
                <button class="btn btn-outline-secondary px-4 py-2 ms-auto border-custom" @onclick='() => NavigationManager.NavigateTo("/surveys")'>
                    <i class="bi bi-x-circle me-2"></i>@(isViewOnly || isSupervisor ? "Back" : "Cancel")
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Template Selection Modal -->
<div class="modal fade @(showTemplateModal ? "show" : "")" tabindex="-1" 
     style="display: @(showTemplateModal ? "block" : "none");">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg bg-card">
            <div class="modal-header bg-secondary text-white border-0">
                <h5 class="modal-title fw-semibold">
                    <i class="bi bi-search me-2"></i>Select Template
                </h5>
                <button type="button" class="btn-close btn-close-white" @onclick="() => showTemplateModal = false"></button>
            </div>
            <div class="modal-body p-4">
                <div class="input-group mb-3">
                    <span class="input-group-text bg-main border-custom">
                        <i class="bi bi-funnel text-primary"></i>
                    </span>
                    <input type="text" class="form-control border-custom" placeholder="Search template name..." 
                           @bind="searchQuery" @bind:event="oninput" />
                </div>
                <div class="table-responsive" style="max-height: 400px;">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-main sticky-top">
                            <tr>
                                <th class="fw-semibold text-title ps-3">ID</th>
                                <th class="fw-semibold text-title">Template Name</th>
                                <th class="fw-semibold text-title text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                var filtered = allTemplates.Where(x => x.TemplateName.Contains(searchQuery, StringComparison.OrdinalIgnoreCase));
                            }
                            @if (!filtered.Any())
                            {
                                <tr>
                                    <td colspan="3" class="text-center py-5 text-muted">
                                        <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                        <p class="mb-0">No templates found</p>
                                    </td>
                                </tr>
                            }
                            else
                            {
                                @foreach (var t in filtered)
                                {
                                    <tr>
                                        <td class="ps-3 fw-semibold text-primary">@t.Id</td>
                                        <td class="text-body">@t.TemplateName</td>
                                        <td class="text-center">
                                            <button class="btn btn-sm btn-primary px-3" @onclick="() => SelectTemplate(t)">
                                                <i class="bi bi-check-circle me-1"></i>Select
                                            </button>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Update Template Modal -->
<div class="modal fade @(showUpdateTemplateModal ? "show" : "")" tabindex="-1" 
     style="display: @(showUpdateTemplateModal ? "block" : "none");">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg bg-card">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold text-title">
                    <i class="bi bi-exclamation-triangle text-warning me-2"></i>Update Template Confirmation
                </h5>
                <button type="button" class="btn-close" @onclick="() => showUpdateTemplateModal = false"></button>
            </div>
            <div class="modal-body p-4">
                <div class="alert alert-warning border-0 mb-3">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Important:</strong> Updating to the latest template will replace all current survey items with the new template structure.
                </div>
                <p class="mb-2 text-title"><strong>Current Status:</strong></p>
                <ul class="mb-3 text-body">
                    <li>Your current answers will be <strong>preserved where possible</strong></li>
                    <li>New questions will be added as empty</li>
                    <li>Removed questions will be deleted</li>
                </ul>
                <p class="text-muted mb-0">
                    Do you want to update this survey to use the latest template version?
                </p>
            </div>
            <div class="modal-footer border-0">
                <button class="btn btn-outline-secondary border-custom px-4" @onclick="() => showUpdateTemplateModal = false">
                    <i class="bi bi-x-circle me-1"></i>No, Keep Current
                </button>
                <button class="btn btn-warning text-white px-4" @onclick="HandleUpdateToLatestTemplate">
                    <i class="bi bi-arrow-repeat me-1"></i>Yes, Update Template
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Submit Confirmation Modal -->
<div class="modal fade @(showSubmitModal ? "show" : "")" tabindex="-1" 
     style="display: @(showSubmitModal ? "block" : "none");">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg bg-card">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold text-title">
                    <i class="bi bi-question-circle text-primary me-2"></i>Confirm Submission
                </h5>
                <button type="button" class="btn-close" @onclick="() => showSubmitModal = false"></button>
            </div>
            <div class="modal-body text-body p-4">
                <p class="mb-0">Are you sure you want to submit this survey for approval?</p>
                <div class="bg-main rounded-3 p-3 mt-3">
                    <small class="text-muted d-block mb-1">Survey Details:</small>
                    <ul class="list-unstyled mb-0 small">
                        <li><strong>Document:</strong> @reqDto.DocumentId</li>
                        <li><strong>Template:</strong> @selectedTemplateName</li>
                        <li><strong>Items:</strong> @reqDto.SurveyItems.Count item(s)</li>
                    </ul>
                </div>
                <div class="alert alert-info border-0 mt-3 mb-0">
                    <small><i class="bi bi-info-circle me-1"></i>Once submitted, you cannot edit this survey until it's reviewed.</small>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-secondary border-custom" @onclick="() => showSubmitModal = false">
                    <i class="bi bi-x-circle me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-success-custom" @onclick="() => ProcessSave(StatusType.ConfirmToApprove)">
                    <i class="bi bi-check-circle me-1"></i>Yes, Submit
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade @(showDeleteModal ? "show" : "")" tabindex="-1" 
     style="display: @(showDeleteModal ? "block" : "none");">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg bg-card">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold text-title">
                    <i class="bi bi-exclamation-triangle text-danger me-2"></i>Confirm Deletion
                </h5>
                <button type="button" class="btn-close" @onclick="() => showDeleteModal = false"></button>
            </div>
            <div class="modal-body text-body p-4">
                <p class="mb-2">Are you sure you want to delete this survey?</p>
                <div class="alert alert-danger border-0 mb-0">
                    <small><i class="bi bi-info-circle me-1"></i>This action cannot be undone!</small>
                </div>
                <div class="bg-main rounded-3 p-3 mt-3">
                    <small class="text-muted d-block mb-1">Survey to be deleted:</small>
                    <ul class="list-unstyled mb-0 small">
                        <li><strong>Document:</strong> @reqDto.DocumentId</li>
                        <li><strong>Template:</strong> @selectedTemplateName</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-secondary border-custom" @onclick="() => showDeleteModal = false">
                    <i class="bi bi-x-circle me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-danger-custom" @onclick="HandleDelete">
                    <i class="bi bi-trash me-1"></i>Yes, Delete
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Approve Confirmation Modal -->
<div class="modal fade @(showApproveModal ? "show" : "")" tabindex="-1" 
     style="display: @(showApproveModal ? "block" : "none");">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg bg-card">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold text-title">
                    <i class="bi bi-check-circle text-success me-2"></i>Confirm Approval
                </h5>
                <button type="button" class="btn-close" @onclick="() => showApproveModal = false"></button>
            </div>
            <div class="modal-body text-body p-4">
                <p class="mb-0">Are you sure you want to approve this survey?</p>
                <div class="bg-main rounded-3 p-3 mt-3">
                    <small class="text-muted d-block mb-1">Survey Details:</small>
                    <ul class="list-unstyled mb-0 small">
                        <li><strong>Document:</strong> @reqDto.DocumentId</li>
                        <li><strong>Requester:</strong> @(requesterData?.Username ?? "N/A")</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-secondary border-custom" @onclick="() => showApproveModal = false">
                    <i class="bi bi-x-circle me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-success-custom" @onclick="HandleApprove">
                    <i class="bi bi-check-circle me-1"></i>Yes, Approve
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Reject Confirmation Modal -->
<div class="modal fade @(showRejectModal ? "show" : "")" tabindex="-1" 
     style="display: @(showRejectModal ? "block" : "none");">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg bg-card">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold text-title">
                    <i class="bi bi-x-circle text-danger me-2"></i>Confirm Rejection
                </h5>
                <button type="button" class="btn-close" @onclick="() => showRejectModal = false"></button>
            </div>
            <div class="modal-body text-body p-4">
                <p class="mb-0">Are you sure you want to reject this survey?</p>
                <div class="bg-main rounded-3 p-3 mt-3">
                    <small class="text-muted d-block mb-1">Survey Details:</small>
                    <ul class="list-unstyled mb-0 small">
                        <li><strong>Document:</strong> @reqDto.DocumentId</li>
                        <li><strong>Requester:</strong> @(requesterData?.Username ?? "N/A")</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-secondary border-custom" @onclick="() => showRejectModal = false">
                    <i class="bi bi-x-circle me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-danger-custom" @onclick="HandleReject">
                    <i class="bi bi-x-circle me-1"></i>Yes, Reject
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Backdrop -->
@if (showTemplateModal || showUpdateTemplateModal || showSubmitModal || showDeleteModal || showApproveModal || showRejectModal)
{
    <div class="modal-backdrop fade show"></div>
}

<style>
    .transition-icon {
        transition: transform 0.3s ease;
    }

    button:not(.collapsed) .transition-icon {
        transform: rotate(180deg);
    }
</style>

@code {
    private SurveyHeaderRequestDTO reqDto = new() { SurveyItems = new() };
    private List<TemplateHeaderResponseDTO> allTemplates = new();
    private UserResponseDTO? requesterData;
    
    private string? currentSurveyId;
    private string selectedTemplateName = "";
    private string selectedTemplateTheme = "";
    private string searchQuery = "";
    private string? alertMessage;
    private string? successMessage;
    private int userPositionId = 0;

    private bool isDataLoaded = false;
    private bool isEditMode = false;
    private bool isSupervisor = false;
    private bool isViewOnly = false;
    private bool hasBeenSaved = false;
    private bool hasAttemptedSubmit = false;

    private bool showTemplateModal = false;
    private bool showUpdateTemplateModal = false;
    private bool showTemplateUpdateWarning = false;
    private bool showSubmitModal = false;
    private bool showDeleteModal = false;
    private bool showApproveModal = false;
    private bool showRejectModal = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadAuthStateFromSession();
            
            if (AuthState.CurrentUser != null)
            {
                isSupervisor = AuthState.CurrentUser.RoleId == 1;
                userPositionId = AuthState.CurrentUser.PositionId;

                await InitializeFormData();
                
                isDataLoaded = true;
                StateHasChanged();
            }
        }
    }

    private async Task LoadAuthStateFromSession()
    {
        try
        {
            var userJson = await JS.InvokeAsync<string>("sessionStorage.getItem", "UserSession");
            if (!string.IsNullOrEmpty(userJson))
            {
                var user = JsonSerializer.Deserialize<User>(userJson);
                if (user != null)
                {
                    AuthState.SetAuthenticationState(user);
                    return;
                }
            }
            NavigationManager.NavigateTo("/login", true);
        }
        catch { NavigationManager.NavigateTo("/login", true); }
    }

    private async Task InitializeFormData()
    {
        allTemplates = await TemplateService.GetTemplateByPositionId(userPositionId) ?? new();
        
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);

        if (query.TryGetValue("surveyId", out var id))
        {
            await LoadExistingSurvey(id!);
        }
        else
        {
            await PrepareNewSurvey();
        }

        DetermineViewOnlyMode();
    }

    private async Task PrepareNewSurvey()
    {
        isEditMode = false;
        hasBeenSaved = false;
        reqDto.DocumentId = await IdGeneratorUtil.GenerateSurveyId(DbContext);
        
        if (AuthState.CurrentUser != null)
        {
            reqDto.RequesterId = AuthState.CurrentUser.Id;
            await LoadRequesterData();
        }
    }

    private async Task LoadExistingSurvey(string id)
    {
        isEditMode = true;
        hasBeenSaved = true;
        currentSurveyId = id;
        
        var data = await SurveyService.GetSurveyHeaderById(id);
        if (data == null) return;

        reqDto = new SurveyHeaderRequestDTO
        {
            DocumentId = data.DocumentId,
            RequesterId = data.RequesterId,
            Status = Enum.Parse<StatusType>(data.Status),
            TemplateHeaderId = data.TemplateHeaderId,
            UpdatedAtTemplate = data.UpdatedAtTemplate,
            SurveyItems = data.SurveyItems.Select(si => new SurveyItemRequestDTO
            {
                Id = si.Id,
                DocumentSurveyId = si.DocumentSurveyId,
                TemplateItemId = si.TemplateItemId,
                Question = si.Question,
                Type = Enum.Parse<QuestionType>(si.Type),
                OrderNo = si.OrderNo,
                Answer = si.Answer,
                CheckBox = si.CheckBox.Select(cb => new SurveyItemDetailRequestDTO
                {
                    Id = cb.Id,
                    DocumentItemId = cb.DocumentItemId,
                    TemplateItemDetailId = cb.TemplateItemDetailId,
                    Item = cb.Item,
                    IsChecked = cb.IsChecked
                }).ToList()
            }).ToList()
        };
        
        selectedTemplateName = data.Header?.TemplateName ?? "N/A";
        selectedTemplateTheme = data.Header?.Theme ?? "N/A";
        
        await LoadRequesterData();

        if (data.Header != null && data.UpdatedAtTemplate != data.Header.UpdatedAt && 
            !isSupervisor && reqDto.Status == StatusType.Draft && !isViewOnly)
        {
            showTemplateUpdateWarning = true;
        }
    }

    private async Task SelectTemplate(TemplateHeaderResponseDTO template)
    {
        var fullTemplate = await TemplateService.GetTemplateByHeaderId(template.Id);
        if (fullTemplate == null) return;

        reqDto.TemplateHeaderId = fullTemplate.Id;
        reqDto.UpdatedAtTemplate = fullTemplate.UpdatedAt;
        selectedTemplateName = fullTemplate.TemplateName;
        selectedTemplateTheme = fullTemplate.Theme;
        
        reqDto.SurveyItems = fullTemplate.Items.Select(i => new SurveyItemRequestDTO
        {
            TemplateItemId = i.Id,
            Question = i.Question,
            Type = Enum.Parse<QuestionType>(i.Type),
            OrderNo = i.OrderNo,
            Answer = "",
            CheckBox = i.ItemDetails.Select(d => new SurveyItemDetailRequestDTO
            {
                TemplateItemDetailId = d.Id,
                Item = d.Item,
                IsChecked = false
            }).ToList()
        }).ToList();
        
        showTemplateModal = false;
        showTemplateUpdateWarning = false;
        alertMessage = null;
        StateHasChanged();
    }

    private async Task HandleUpdateToLatestTemplate()
    {
        try
        {
            showUpdateTemplateModal = false;
            var latestTemplate = await TemplateService.GetTemplateByHeaderId(reqDto.TemplateHeaderId!);
            if (latestTemplate == null) return;

            var updatePayload = new SurveyHeaderRequestDTO 
            {
                TemplateHeaderId = latestTemplate.Id,
                UpdatedAtTemplate = latestTemplate.UpdatedAt,
                Status = reqDto.Status,
                SurveyItems = latestTemplate.Items.Select(i => new SurveyItemRequestDTO 
                {
                    TemplateItemId = i.Id,
                    Question = i.Question,
                    Type = Enum.Parse<QuestionType>(i.Type),
                    OrderNo = i.OrderNo,
                    CheckBox = i.ItemDetails.Select(d => new SurveyItemDetailRequestDTO 
                    {
                        TemplateItemDetailId = d.Id,
                        Item = d.Item
                    }).ToList()
                }).ToList()
            };

            var result = await SurveyService.UpdateSurveyHeaderFromLatestTemplate(currentSurveyId!, updatePayload);
            if (result != null)
            {
                await LoadExistingSurvey(currentSurveyId!);
                showTemplateUpdateWarning = false;
                successMessage = "Template updated and answers preserved successfully!";
                StateHasChanged();
            }
        }
        catch (Exception ex) { alertMessage = "Error: " + ex.Message; }
    }

    private void ValidateAndShowSubmitModal()
    {
        hasAttemptedSubmit = true;
        alertMessage = null;

        if (string.IsNullOrEmpty(reqDto.TemplateHeaderId))
        {
            alertMessage = "Please select a template first";
            return;
        }

        bool hasEmptyAnswers = reqDto.SurveyItems.Any(item => 
        {
            if (item.Type == QuestionType.CheckBox)
            {
                return !item.CheckBox.Any(cb => cb.IsChecked);
            }
            return string.IsNullOrWhiteSpace(item.Answer);
        });

        if (hasEmptyAnswers)
        {
            alertMessage = "Please complete all required fields before submitting";
            return;
        }

        showSubmitModal = true;
    }

    private async Task HandleApprove()
    {
        showApproveModal = false;
        await UpdateStatus("Confirmed", "Survey has been approved successfully!");
    }

    private async Task HandleReject()
    {
        showRejectModal = false;
        await UpdateStatus("Rejected", "Survey has been rejected!");
    }

    private async Task UpdateStatus(string status, string alertMsg)
    {
        try
        {
            var result = await SurveyService.UpdateSurveyHeaderStatus(currentSurveyId!, status);
            if (result != null)
            {
                successMessage = alertMsg;
                await Task.Delay(1500);
                NavigationManager.NavigateTo("/surveys");
            }
        }
        catch (Exception ex) { alertMessage = "Error: " + ex.Message; }
    }

    private async Task HandleSaveDraft() => await ProcessSave(StatusType.Draft);

    private async Task ProcessSave(StatusType status)
    {
        if (isViewOnly) return;
        try
        {
            showSubmitModal = false;
            
            if (string.IsNullOrEmpty(reqDto.TemplateHeaderId))
            {
                alertMessage = "Please select a template first";
                return;
            }

            reqDto.Status = status;
            if (isEditMode) await SurveyService.UpdateSurveyHeader(currentSurveyId!, reqDto);
            else await SurveyService.CreateSurveyHeader(reqDto);
            
            hasBeenSaved = true;
            successMessage = status == StatusType.Draft ? "Draft saved successfully!" : "Survey submitted successfully!";
            await Task.Delay(1500);
            NavigationManager.NavigateTo("/surveys");
        }
        catch (Exception ex) { alertMessage = "Error: " + ex.Message; }
    }

    private async Task HandleDelete()
    {
        if (isViewOnly) return;
        showDeleteModal = false;
        
        try
        {
            await SurveyService.DeleteSurveyHeader(currentSurveyId!);
            successMessage = "Survey deleted successfully!";
            await Task.Delay(1000);
            NavigationManager.NavigateTo("/surveys");
        }
        catch (Exception ex) { alertMessage = "Error: " + ex.Message; }
    }

    private void DetermineViewOnlyMode()
    {
        if (isSupervisor) isViewOnly = true;
        else if (isEditMode) isViewOnly = reqDto.Status != StatusType.Draft;
        else isViewOnly = false;
    }

    private async Task LoadRequesterData()
    {
        if (!string.IsNullOrEmpty(reqDto.RequesterId))
            requesterData = await UserService.GetUserById(reqDto.RequesterId);
    }

    private string GetPageTitle() => isSupervisor ? "Review Survey" : (isViewOnly ? "View Survey" : (isEditMode ? "Edit Survey" : "Create New Survey"));
    private string GetPageSubtitle() => isSupervisor ? $"Review: {reqDto.DocumentId}" : (isViewOnly ? $"View: {reqDto.DocumentId}" : (isEditMode ? $"Modify: {reqDto.DocumentId}" : "Fill out survey form"));
    private string GetCurrentStatus() => (!hasBeenSaved && !isEditMode) ? "New" : reqDto.Status.ToString();
    private string GetStatusDisplay(string status) => status == "ConfirmToApprove" ? "Pending Approval" : status;
    private string GetStatusBadgeClass(string status) => status switch
    {
        "New" => "bg-secondary", 
        "Draft" => "bg-warning text-dark", 
        "ConfirmToApprove" => "bg-info text-dark", 
        "Confirmed" => "badge-success-custom", 
        "Rejected" => "badge-danger-custom", 
        _ => "bg-secondary"
    };
}